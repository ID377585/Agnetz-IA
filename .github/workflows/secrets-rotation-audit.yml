name: Secrets Rotation Audit

on:
  schedule:
    - cron: "0 6 * * *" # daily
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

env:
  SECRET_PROVIDER: ${{ vars.SECRET_PROVIDER || 'gcp' }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  GCP_PROJECT: ${{ vars.GCP_PROJECT }}
  SECRETS_LIST: ${{ vars.SECRETS_LIST }} # comma-separated ARNs or names

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          set -euo pipefail
          if [ -z "${SECRETS_LIST}" ]; then
            echo "SECRETS_LIST is empty; nothing to audit."
            exit 0
          fi

      - name: Configure AWS creds (OIDC)
        if: ${{ env.SECRET_PROVIDER == 'aws' && secrets.AWS_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Auth to GCP (OIDC)
        if: ${{ env.SECRET_PROVIDER == 'gcp' && secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT != '' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        if: ${{ env.SECRET_PROVIDER == 'gcp' && secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT != '' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Audit AWS Secrets Manager rotation/expiry
        if: ${{ env.SECRET_PROVIDER == 'aws' && secrets.AWS_ROLE_ARN != '' }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          IFS=',' read -ra SECRETS <<< "${SECRETS_LIST}"
          failures=0
          now=$(date -u +%s)

          for s in "${SECRETS[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Checking $s"
            desc=$(aws secretsmanager describe-secret --secret-id "$s" --region "${AWS_REGION}")
            rotation=$(echo "$desc" | jq -r '.RotationEnabled')
            if [ "$rotation" != "true" ]; then
              echo "Rotation not enabled for $s"
              failures=$((failures+1))
            fi
            expires=$(echo "$desc" | jq -r '.Tags[]? | select(.Key=="expires_at") | .Value' || true)
            if [ -n "$expires" ]; then
              exp_ts=$(date -u -d "$expires" +%s || echo 0)
              if [ "$exp_ts" -le "$now" ]; then
                echo "Secret expired: $s (expires_at=$expires)"
                failures=$((failures+1))
              fi
            else
              echo "Missing expires_at tag for $s"
              failures=$((failures+1))
            fi
          done

          if [ "$failures" -gt 0 ]; then
            echo "Rotation audit failed ($failures issues)."
            exit 1
          fi

      - name: Provider not configured
        if: ${{ (env.SECRET_PROVIDER == 'aws' && secrets.AWS_ROLE_ARN == '') || (env.SECRET_PROVIDER == 'gcp' && (secrets.GCP_WORKLOAD_IDENTITY_PROVIDER == '' || secrets.GCP_SERVICE_ACCOUNT == '')) || (env.SECRET_PROVIDER != 'aws' && env.SECRET_PROVIDER != 'gcp') }}
        run: |
          echo "Provider not configured. Set SECRET_PROVIDER and provider credentials to enable audit."

      - name: Audit GCP Secret Manager rotation/expiry
        if: ${{ env.SECRET_PROVIDER == 'gcp' && secrets.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && secrets.GCP_SERVICE_ACCOUNT != '' }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          if [ -z "${GCP_PROJECT}" ]; then
            echo "GCP_PROJECT is required"
            exit 1
          fi

          IFS=',' read -ra SECRETS <<< "${SECRETS_LIST}"
          failures=0
          now=$(date -u +%s)
          warn_window=$((7*24*3600))

          for s in "${SECRETS[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Checking $s"
            desc=$(gcloud secrets describe "$s" --project "${GCP_PROJECT}" --format=json)
            rotation=$(echo "$desc" | jq -r '.rotation? // empty')
            if [ -z "$rotation" ] || [ "$rotation" = "null" ]; then
              echo "Rotation not configured for $s"
              failures=$((failures+1))
            fi
            next_rot=$(echo "$desc" | jq -r '.rotation.nextRotationTime // empty')
            if [ -n "$next_rot" ] && [ "$next_rot" != "null" ]; then
              next_ts=$(date -u -d "$next_rot" +%s || echo 0)
              if [ "$next_ts" -le "$now" ]; then
                echo "Rotation overdue: $s (nextRotationTime=$next_rot)"
                failures=$((failures+1))
              elif [ "$next_ts" -le $((now+warn_window)) ]; then
                echo "Rotation due soon: $s (nextRotationTime=$next_rot)"
                failures=$((failures+1))
              fi
            else
              echo "Missing nextRotationTime for $s"
              failures=$((failures+1))
            fi
          done

          if [ "$failures" -gt 0 ]; then
            echo "Rotation audit failed ($failures issues)."
            exit 1
          fi
