name: Secrets Rotation Audit

on:
  schedule:
    - cron: "0 6 * * *" # daily
  workflow_dispatch:

permissions:
  contents: read
  id-token: write
  issues: write

env:
  SECRET_PROVIDER: ${{ vars.SECRET_PROVIDER || 'aws' }}
  AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
  SECRETS_LIST: ${{ vars.SECRETS_LIST }} # comma-separated ARNs or names

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - name: Validate inputs
        run: |
          set -euo pipefail
          if [ -z "${SECRETS_LIST}" ]; then
            echo "SECRETS_LIST is empty; nothing to audit."
            exit 0
          fi

      - name: Configure AWS creds (OIDC)
        if: ${{ env.SECRET_PROVIDER == 'aws' && secrets.AWS_ROLE_ARN != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Audit AWS Secrets Manager rotation/expiry
        if: ${{ env.SECRET_PROVIDER == 'aws' && secrets.AWS_ROLE_ARN != '' }}
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq

          IFS=',' read -ra SECRETS <<< "${SECRETS_LIST}"
          failures=0
          now=$(date -u +%s)

          for s in "${SECRETS[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Checking $s"
            desc=$(aws secretsmanager describe-secret --secret-id "$s" --region "${AWS_REGION}")
            rotation=$(echo "$desc" | jq -r '.RotationEnabled')
            if [ "$rotation" != "true" ]; then
              echo "Rotation not enabled for $s"
              failures=$((failures+1))
            fi
            expires=$(echo "$desc" | jq -r '.Tags[]? | select(.Key=="expires_at") | .Value' || true)
            if [ -n "$expires" ]; then
              exp_ts=$(date -u -d "$expires" +%s || echo 0)
              if [ "$exp_ts" -le "$now" ]; then
                echo "Secret expired: $s (expires_at=$expires)"
                failures=$((failures+1))
              fi
            else
              echo "Missing expires_at tag for $s"
              failures=$((failures+1))
            fi
          done

          if [ "$failures" -gt 0 ]; then
            echo "Rotation audit failed ($failures issues)."
            exit 1
          fi

      - name: Provider not configured
        if: ${{ env.SECRET_PROVIDER != 'aws' || secrets.AWS_ROLE_ARN == '' }}
        run: |
          echo "Provider not configured. Set SECRET_PROVIDER and provider credentials to enable audit."
