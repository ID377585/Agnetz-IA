name: Secrets Rotation Setup (Vault)

on:
  workflow_dispatch:
    inputs:
      rotation_days:
        description: "Rotation period in days (metadata only)"
        required: false
        default: "90"

permissions:
  contents: read
  id-token: write

env:
  VAULT_ADDR: ${{ vars.VAULT_ADDR }}
  VAULT_NAMESPACE: ${{ vars.VAULT_NAMESPACE }}
  VAULT_KV_MOUNT: ${{ vars.VAULT_KV_MOUNT || 'secret' }}
  SECRETS_LIST: ${{ vars.SECRETS_LIST }} # comma-separated paths relative to mount
  VAULT_ROLE: ${{ secrets.VAULT_ROLE }}
  VAULT_JWT_AUTH_PATH: ${{ secrets.VAULT_JWT_AUTH_PATH }}

jobs:
  setup:
    runs-on: [self-hosted, vault-local]
    steps:
      - name: Preflight Vault URL
        run: |
          set -euo pipefail
          if echo "${VAULT_ADDR}" | grep -qE '127\\.0\\.0\\.1|localhost'; then
            echo "VAULT_ADDR points to localhost; GitHub-hosted runner cannot reach it. Use a public Vault endpoint or a self-hosted runner."
            exit 0
          fi

      - name: Auth to Vault (OIDC)
        if: ${{ env.VAULT_ROLE != '' && env.VAULT_JWT_AUTH_PATH != '' }}
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: ${{ env.VAULT_ROLE }}
          jwtAuthPath: ${{ env.VAULT_JWT_AUTH_PATH }}
          namespace: ${{ env.VAULT_NAMESPACE }}

      - name: Set rotation metadata
        run: |
          set -euo pipefail
          if [ -z "${SECRETS_LIST}" ]; then
            echo "SECRETS_LIST is empty; nothing to configure."
            exit 0
          fi

          days="${{ github.event.inputs.rotation_days }}"
          now=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          expires=$(date -u -d "+${days} days" +%Y-%m-%dT%H:%M:%SZ)

          IFS=',' read -ra SECRETS <<< "${SECRETS_LIST}"
          for s in "${SECRETS[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Setting metadata for $s"
            vault kv metadata put "${VAULT_KV_MOUNT}/${s}" \
              -custom-metadata=rotation_days="${days}" \
              -custom-metadata=last_rotated="${now}" \
              -custom-metadata=expires_at="${expires}"
          done
