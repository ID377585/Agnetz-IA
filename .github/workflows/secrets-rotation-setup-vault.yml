name: Secrets Rotation Setup (Vault)

on:
  workflow_dispatch:
    inputs:
      rotation_days:
        description: "Rotation period in days (metadata only)"
        required: false
        default: "90"

permissions:
  contents: read
  id-token: write

env:
  VAULT_ADDR: ${{ vars.VAULT_ADDR }}
  VAULT_NAMESPACE: ${{ vars.VAULT_NAMESPACE }}
  VAULT_KV_MOUNT: ${{ vars.VAULT_KV_MOUNT || 'secret' }}
  SECRETS_LIST: ${{ vars.SECRETS_LIST }} # comma-separated paths relative to mount
  VAULT_ROLE: ${{ secrets.VAULT_ROLE }}
  VAULT_JWT_AUTH_PATH: ${{ secrets.VAULT_JWT_AUTH_PATH }}

jobs:
  setup:
    runs-on: [self-hosted, vault-local]
    steps:
      - name: Auth to Vault (OIDC)
        if: ${{ env.VAULT_ROLE != '' && env.VAULT_JWT_AUTH_PATH != '' }}
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ env.VAULT_ADDR }}
          method: jwt
          role: ${{ env.VAULT_ROLE }}
          path: ${{ env.VAULT_JWT_AUTH_PATH }}
          namespace: ${{ env.VAULT_NAMESPACE }}

      - name: Set rotation metadata
        run: |
          set -euo pipefail
          if [ -z "${SECRETS_LIST}" ]; then
            echo "SECRETS_LIST is empty; nothing to configure."
            exit 0
          fi

          days="${{ github.event.inputs.rotation_days }}"
          now=$(python3 - <<'PY'
import datetime as d
print(d.datetime.now(d.timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ"))
PY
)
          expires=$(python3 - <<PY
import datetime as d
days=int("${days}")
print((d.datetime.now(d.timezone.utc)+d.timedelta(days=days)).strftime("%Y-%m-%dT%H:%M:%SZ"))
PY
)

          IFS=',' read -ra SECRETS <<< "${SECRETS_LIST}"
          for s in "${SECRETS[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Setting metadata for $s"
            vault kv metadata put "${VAULT_KV_MOUNT}/${s}" \
              -custom-metadata=rotation_days="${days}" \
              -custom-metadata=last_rotated="${now}" \
              -custom-metadata=expires_at="${expires}"
          done
