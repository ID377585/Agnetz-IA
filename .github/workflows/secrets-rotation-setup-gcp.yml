name: Secrets Rotation Setup (GCP)

on:
  workflow_dispatch:
    inputs:
      rotation_days:
        description: "Rotation period in days"
        required: false
        default: "90"

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT: ${{ vars.GCP_PROJECT }}
  SECRETS_LIST: ${{ vars.SECRETS_LIST }} # comma-separated secret IDs

jobs:
  setup:
    if: ${{ vars.SECRET_PROVIDER == 'gcp' }}
    runs-on: ubuntu-latest
    env:
      GCP_WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
      GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
    steps:
      - name: Auth to GCP (OIDC)
        if: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT != '' }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        if: ${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER != '' && env.GCP_SERVICE_ACCOUNT != '' }}
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      - name: Configure rotation policy
        run: |
          set -euo pipefail
          if [ -z "${GCP_PROJECT}" ]; then
            echo "GCP_PROJECT is required"
            exit 1
          fi
          if [ -z "${SECRETS_LIST}" ]; then
            echo "SECRETS_LIST is empty; nothing to configure."
            exit 0
          fi

          days="${{ github.event.inputs.rotation_days }}"
          period="${days}d"
          now=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          IFS=',' read -ra SECRETS <<< "${SECRETS_LIST}"
          for s in "${SECRETS[@]}"; do
            s=$(echo "$s" | xargs)
            if [ -z "$s" ]; then
              continue
            fi
            echo "Setting rotation for $s: period=$period next=$now"
            gcloud secrets update "$s" \
              --project "${GCP_PROJECT}" \
              --rotation-period="$period" \
              --next-rotation-time="$now"
          done
