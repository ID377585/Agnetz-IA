name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      rollback_tag:
        description: "Tag para rollback (ex: v1.2.3). Se vazio, usa tag anterior."
        required: false
        default: ""

jobs:
  build:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dev
          POSTGRES_PASSWORD: dev
          POSTGRES_DB: devdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U dev"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Frontend build
        if: ${{ hashFiles('frontend/package.json') != '' }}
        run: |
          cd frontend
          npm install
          npm run lint
          npm test
          npm run build

      - name: Backend build
        if: ${{ hashFiles('backend/package.json') != '' }}
        env:
          DATABASE_URL: postgresql://dev:dev@localhost:5432/devdb?schema=public
        run: |
          cd backend
          npm install
          npm run lint
          npx prisma migrate deploy
          npx prisma generate
          npm run build
          npm test

  e2e:
    runs-on: ubuntu-latest
    if: ${{ hashFiles('docker-compose.yml') != '' }}
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: dev
          POSTGRES_PASSWORD: dev
          POSTGRES_DB: devdb
        ports:
          - 5432:5432
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
      - name: Install root deps
        run: npm install
      - name: Install Playwright
        run: npm run e2e:install
      - name: Start stack
        run: docker compose up --build -d
      - name: Wait backend
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:4000/api/health >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          exit 1
      - name: Run E2E
        run: npm run e2e:ci

  release:
    if: github.ref == 'refs/heads/main' && github.actor != 'github-actions[bot]'
    needs: [build, e2e]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    env:
      REGISTRY_PROVIDER: ${{ vars.REGISTRY_PROVIDER || 'ghcr' }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      GCP_PROJECT: ${{ vars.GCP_PROJECT }}
      GCP_REPO: ${{ vars.GCP_REPO }}
      GCP_REGION: ${{ vars.GCP_REGION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Configure AWS creds
        if: ${{ env.REGISTRY_PROVIDER == 'ecr' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GHCR
        if: ${{ env.REGISTRY_PROVIDER == 'ghcr' }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Login to ECR
        if: ${{ env.REGISTRY_PROVIDER == 'ecr' }}
        uses: aws-actions/amazon-ecr-login@v2
      - name: Login to GAR
        if: ${{ env.REGISTRY_PROVIDER == 'gar' }}
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: _json_key
          password: ${{ secrets.GCP_GAR_JSON }}
      - name: Compute version
        run: |
          VERSION=$(bash scripts/semver.sh)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          if [ "${REGISTRY_PROVIDER}" = "ecr" ]; then
            echo "REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com" >> $GITHUB_ENV
          elif [ "${REGISTRY_PROVIDER}" = "gar" ]; then
            echo "REGISTRY=${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT}/${GCP_REPO}" >> $GITHUB_ENV
          else
            echo "REGISTRY=ghcr.io" >> $GITHUB_ENV
          fi
      - name: Build & push images
        run: |
          BACKEND=${{ env.REGISTRY }}/${{ github.repository }}-backend
          FRONTEND=${{ env.REGISTRY }}/${{ github.repository }}-frontend
          docker buildx build --push -t $BACKEND:${{ env.VERSION }} -t $BACKEND:latest backend
          docker buildx build --push -t $FRONTEND:${{ env.VERSION }} -t $FRONTEND:latest frontend
      - name: Update manifests (GitOps)
        run: |
          export REGISTRY=${{ env.REGISTRY }}
          python scripts/update_k8s_images.py --tag ${{ env.VERSION }} --k8s-path k8s/apps/generated-app --extra "k8s/overlays/staging;k8s/overlays/prod"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add k8s/apps/generated-app
          git add k8s/overlays
          echo "$(date -u +%FT%TZ) release ${{ env.VERSION }} by ${{ github.actor }}" >> k8s/audit/approvals.log
          git add k8s/audit/approvals.log
          git commit -m "chore(release): ${{ env.VERSION }}"
          git tag ${{ env.VERSION }}
          git push origin HEAD
          git push origin ${{ env.VERSION }}

  rollback:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    environment: production
    env:
      REGISTRY_PROVIDER: ${{ vars.REGISTRY_PROVIDER || 'ghcr' }}
      AWS_REGION: ${{ vars.AWS_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
      GCP_PROJECT: ${{ vars.GCP_PROJECT }}
      GCP_REPO: ${{ vars.GCP_REPO }}
      GCP_REGION: ${{ vars.GCP_REGION }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Resolve rollback tag
        run: |
          TAG="${{ github.event.inputs.rollback_tag }}"
          if [ -z "$TAG" ]; then
            TAG=$(bash scripts/prev_tag.sh)
          fi
          if [ -z "$TAG" ]; then
            echo "No previous tag found" && exit 1
          fi
          echo "TAG=$TAG" >> $GITHUB_ENV
      - name: Update manifests to rollback tag
        run: |
          if [ "${REGISTRY_PROVIDER}" = "ecr" ]; then
            export REGISTRY=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
          elif [ "${REGISTRY_PROVIDER}" = "gar" ]; then
            export REGISTRY=${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT}/${GCP_REPO}
          else
            export REGISTRY=ghcr.io
          fi
          python scripts/update_k8s_images.py --tag ${{ env.TAG }} --k8s-path k8s/apps/generated-app --extra "k8s/overlays/staging;k8s/overlays/prod"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add k8s/apps/generated-app
          git add k8s/overlays
          echo "$(date -u +%FT%TZ) rollback ${{ env.TAG }} by ${{ github.actor }}" >> k8s/audit/approvals.log
          git add k8s/audit/approvals.log
          git commit -m "chore(rollback): ${{ env.TAG }}"
          git push origin HEAD
